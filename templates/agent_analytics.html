{% extends "base.html" %}

{% block title %}Agent - Sales Analytics{% endblock %}

{% block header_title %}Agent Sales and Commission Analytics{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .analytics-container { padding: 20px; }
    
    /* Summary Cards */
    .summary-row { display: flex; gap: 20px; margin-bottom: 40px; }
    .summary-card {
        flex: 1;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }
    .summary-card h3 { margin: 0 0 10px 0; color: #555; font-size: 1em; }
    .summary-card .value { font-size: 2em; font-weight: bold; color: #28a745; }
    
    /* Charts Section */
    .charts-row { display: flex; gap: 30px; margin-bottom: 40px; flex-wrap: wrap; }
    .chart-container {
        flex: 1;
        min-width: 400px;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h4 { text-align: center; margin-bottom: 20px; color: #333; }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <h2>Agent Performance Overview</h2>
    <p style="color: #666; margin-bottom: 20px;">Summary of sales and commissions for the last 30 days.</p>

    <!-- Summary Cards -->
    <div class="summary-row">
        <div class="summary-card">
            <h3>Tickets Sold (30 Days)</h3>
            <div class="value">{{ stats.total_tickets or 0 }}</div>
        </div>
        <div class="summary-card">
            <h3>Total Commission (30 Days)</h3>
            <div class="value">${{ stats.total_commission or 0 }}</div>
        </div>
        <div class="summary-card">
            <h3>Avg Commission / Ticket</h3>
            <div class="value">${{ stats.avg_commission | round(2) if stats.avg_commission else 0 }}</div>
        </div>
    </div>

    <hr>

    <!-- Charts -->
    <div class="charts-row">
        <!-- Chart 1: Top Customers by Tickets -->
        <div class="chart-container">
            <h4>Top 5 Customers (Tickets - Last 6 Months)</h4>
            <canvas id="ticketsChart"></canvas>
        </div>

        <!-- Chart 2: Top Customers by Commission -->
        <div class="chart-container">
            <h4>Top 5 Customers (Commission - Last Year)</h4>
            <canvas id="commissionChart"></canvas>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Data from Flask
        const ticketData = {{ top_tickets | tojson }};
        const commissionData = {{ top_commission | tojson }};

        // 1. Tickets Chart
        const ticketLabels = ticketData.map(d => d.customer_email.split('@')[0]); // Shorten email for label
        const ticketValues = ticketData.map(d => d.ticket_count);
        
        new Chart(document.getElementById('ticketsChart'), {
            type: 'bar',
            data: {
                labels: ticketLabels,
                datasets: [{
                    label: 'Number of Tickets',
                    data: ticketValues,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });

        // 2. Commission Chart
        const commLabels = commissionData.map(d => d.customer_email.split('@')[0]);
        const commValues = commissionData.map(d => d.total_comm);

        new Chart(document.getElementById('commissionChart'), {
            type: 'bar',
            data: {
                labels: commLabels,
                datasets: [{
                    label: 'Total Commission ($)',
                    data: commValues,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    });
</script>
{% endblock %}