{% extends "base.html" %}

{% block title %}Agent - Search and Purchase Flights{% endblock %}

{% block header_title %}Agent Flight Search{% endblock %}

{% block head_extra %}
<style>
    /* 沿用之前优化的 search-form 样式，确保对齐 */
    .search-form {
        background-color: #f0f8ff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        border: 1px solid #cceeff;
        display: flex;
        align-items: flex-end; 
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        flex: 1; /* 让所有表单组平均分配空间 */
        min-width: 150px; /* 设置最小宽度防止过小 */
        justify-content: flex-end;
    }
    
    .search-form input[type="date"],
    .search-form input[type="text"] {
        width: 100%;
        box-sizing: border-box; 
    }
    
    /* 结果表中的 Purchase 区域样式 */
    .purchase-cell {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .purchase-cell input[type="email"] {
        width: 180px; /* 增加邮箱输入框的宽度 */
        padding: 5px 8px;
        height: 30px;
        box-sizing: border-box;
    }

    .purchase-cell button {
        padding: 5px 10px;
        font-size: 0.9em;
        height: 30px; /* 与输入框高度一致 */
        line-height: 18px;
        margin-top: 0 !important; /* 覆盖 base.html 的 margin-top */
        background-color: #28a745; /* 绿色购买按钮 */
    }
    
    .no-results {
        text-align: center;
        padding: 50px;
        color: #666;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
    <h2>Search Flights for Purchase</h2>

    <form class="search-form" method="POST" action="{{ url_for('agent.search') }}">
        
        <div class="form-group">
            <label for="origin">Origin Airport:</label>
            <input type="text" id="origin" name="origin" value="{{ request.form.get('origin', '') }}" placeholder="Airport Code">
        </div>
        
        <div class="form-group">
            <label for="destination">Destination Airport:</label>
            <input type="text" id="destination" name="destination" value="{{ request.form.get('destination', '') }}" placeholder="Airport Code">
        </div>

        <div class="form-group">
            <label for="date">Departure Date:</label>
            <input type="date" id="date" name="date" value="{{ request.form.get('date', '') }}" required>
        </div>

        <div class="form-group button-group">
            <label style="visibility: hidden;">Search</label> 
            <button type="submit">Search Flights</button>
        </div>
    </form>
    
    {% if flights %}
    <h3>Found {{ flights | length }} Upcoming Flights</h3>
    <table>
        <thead>
            <tr>
                <th>Airline</th>
                <th>Flight No</th>
                <th>Origin</th>
                <th>Destination</th>
                <th>Departure Time</th>
                <th>Arrival Time</th>
                <th>Price</th>
                <th>Status</th>
                <th>Customer Email & Purchase</th> 
            </tr>
        </thead>
        <tbody>
            {% for f in flights %}
            <tr>
                <td>{{ f.airline_name }}</td>
                <td>{{ f.flight_number }}</td>
                <td>{{ f.departure_airport }}</td>
                <td>{{ f.arrival_airport }}</td>
                <td>{{ f.departure_time | datetimeformat }}</td>
                <td>{{ f.arrival_time | datetimeformat }}</td>
                <td>${{ f.price }}</td>
                <td>
                    <span class="status-{{ f.status | lower | replace(' ', '-') }}">
                        {{ f.status }}
                    </span>
                </td>
                <td>
                    <form method="POST" action="{{ url_for('agent.purchase') }}" class="purchase-cell">
                        <input type="hidden" name="airline_name" value="{{ f.airline_name }}">
                        <input type="hidden" name="flight_number" value="{{ f.flight_number }}">
                        
                        <input type="email" name="customer_email" placeholder="Customer Email" required>
                        
                        <button type="submit" class="btn-primary">Buy</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% elif request.method == "POST" %}
    <p class="no-results">No upcoming flights found matching your search criteria and authorized airlines.</p>
    {% else %}
    <p class="no-results">Enter your search criteria to find available flights from your authorized airlines.</p>
    {% endif %}

{% endblock %}