{% extends "base.html" %}
{% block title %}Airline Analytics{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .analytics-container { padding: 20px; max-width: 1200px; margin: 0 auto; }
    
    /* Summary Cards */
    .summary-row { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
    .summary-card {
        flex: 1;
        min-width: 250px;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
        border-left: 5px solid #007bff;
    }
    .summary-card h3 { margin: 0 0 10px 0; color: #555; font-size: 1em; }
    .summary-card .value { font-size: 1.5em; font-weight: bold; color: #333; }
    .summary-card .sub-text { font-size: 0.9em; color: #777; margin-top: 5px; }

    /* Charts Grid */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 30px;
        margin-bottom: 40px;
    }
    .chart-card {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .chart-card h4 { text-align: center; margin-bottom: 20px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    
    /* Lists */
    .list-group { list-style: none; padding: 0; margin: 0; }
    .list-item { 
        padding: 10px; 
        border-bottom: 1px solid #eee; 
        display: flex; 
        justify-content: space-between;
        align-items: center;
    }
    .list-item:last-child { border-bottom: none; }
    .badge { 
        background: #e9ecef; 
        padding: 4px 8px; 
        border-radius: 4px; 
        font-size: 0.85em; 
        color: #495057;
    }
    
    .btn-back { text-decoration: none; color: #007bff; font-weight: bold; }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>Analytics for {{ airline_name }}</h2>
        <a href="{{ url_for('staff.dashboard') }}" style="text-decoration: none; color: #007bff; font-weight: bold;">&larr; Back to Dashboard</a>
    </div>
    <hr>

    <!-- 1. Key Metrics / Frequent Customer -->
    <div class="summary-row">
        <div class="summary-card" style="border-left-color: #28a745;">
            <h3>Most Frequent Customer (Year)</h3>
            {% if most_freq_customer %}
                <div class="value">{{ most_freq_customer.customer_email.split('@')[0] }}</div>
                <div class="sub-text">{{ most_freq_customer.customer_email }}</div>
                <div class="sub-text"><strong>{{ most_freq_customer.cnt }}</strong> flights taken</div>
            {% else %}
                <div class="value">N/A</div>
                <div class="sub-text">No data available</div>
            {% endif %}
        </div>
        
        <div class="summary-card" style="border-left-color: #17a2b8;">
            <h3>Total Tickets Sold (Year)</h3>
            <div class="value">{{ counts | sum }}</div>
            <div class="sub-text">Across all months</div>
        </div>
    </div>

    <div class="charts-grid">
        <!-- 2. Tickets Sold Per Month (Line Chart) -->
        <div class="chart-card">
            <h4>Tickets Sold Per Month</h4>
            <canvas id="ticketsMonthChart"></canvas>
        </div>

        <!-- 3. Flight Status Breakdown (Pie Chart) -->
        <div class="chart-card">
            <h4>On-time vs Delayed Performance</h4>
            <div style="max-width: 300px; margin: 0 auto;">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>

    <div class="charts-grid">
        <!-- 4. Top Agents (Bar Chart - Month vs Year) -->
        <div class="chart-card">
            <h4>Top Agents (By Ticket Count)</h4>
            <div style="margin-bottom: 15px; text-align: center;">
                <button onclick="toggleAgentChart('month')" id="btnMonth" style="padding: 5px 10px; cursor: pointer;">Last Month</button>
                <button onclick="toggleAgentChart('year')" id="btnYear" style="padding: 5px 10px; cursor: pointer;">Last Year</button>
            </div>
            <canvas id="agentsChart"></canvas>
        </div>

        <!-- 5. Top Destinations -->
        <div class="chart-card">
            <h4>Top Destinations</h4>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <h5 style="text-align: center; color: #666;">Last 3 Months</h5>
                    <ul class="list-group">
                        {% for d in top_dest_3m %}
                        <li class="list-item">
                            <span>{{ d.arrival_airport }}</span>
                            <span class="badge">{{ d.cnt }}</span>
                        </li>
                        {% else %}
                        <li class="list-item" style="color: #999;">No data</li>
                        {% endfor %}
                    </ul>
                </div>
                <div style="border-left: 1px solid #eee;"></div>
                <div style="flex: 1;">
                    <h5 style="text-align: center; color: #666;">Last Year</h5>
                    <ul class="list-group">
                        {% for d in top_dest_1y %}
                        <li class="list-item">
                            <span>{{ d.arrival_airport }}</span>
                            <span class="badge">{{ d.cnt }}</span>
                        </li>
                        {% else %}
                        <li class="list-item" style="color: #999;">No data</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. Tickets Per Month Chart ---
        const monthLabels = {{ months | tojson }};
        const monthCounts = {{ counts | tojson }};
        
        new Chart(document.getElementById('ticketsMonthChart'), {
            type: 'line',
            data: {
                labels: monthLabels,
                datasets: [{
                    label: 'Tickets Sold',
                    data: monthCounts,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });

        // --- 2. Status Pie Chart (Filtered for Delayed vs On-time) ---
        const rawStatusLabels = {{ statuses | tojson }};
        const rawStatusData = {{ status_counts | tojson }};
        
        const filteredLabels = [];
        const filteredData = [];
        const targetStatuses = ['delayed', 'on-time'];

        rawStatusLabels.forEach((label, index) => {
            if (targetStatuses.includes(label.toLowerCase())) {
                filteredLabels.push(label);
                filteredData.push(rawStatusData[index]);
            }
        });

        const statusColors = {
            'delayed': '#dc3545',
            'on-time': '#28a745'
        };
        const bgColors = filteredLabels.map(s => statusColors[s.toLowerCase()] || '#ccc');

        new Chart(document.getElementById('statusChart'), {
            type: 'doughnut',
            data: {
                labels: filteredLabels,
                datasets: [{
                    data: filteredData,
                    backgroundColor: bgColors
                }]
            },
            options: { 
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    title: {
                        display: true,
                        text: filteredData.length ? 'Past Flights Performance' : 'No Data Available'
                    }
                }
            }
        });

        // --- 3. Top Agents Chart (Toggle Logic) ---
        const agentsMonth = {{ top_agent_month | tojson }};
        const agentsYear = {{ top_agent_year | tojson }};
        
        let agentChartInstance = null;

        window.toggleAgentChart = function(period) {
            const ctx = document.getElementById('agentsChart');
            const data = period === 'month' ? agentsMonth : agentsYear;
            
            // Update button styles
            document.getElementById('btnMonth').style.fontWeight = period === 'month' ? 'bold' : 'normal';
            document.getElementById('btnYear').style.fontWeight = period === 'year' ? 'bold' : 'normal';

            const labels = data.map(d => d.agent_email.split('@')[0]);
            const values = data.map(d => d.ticket_count);
            const comms = data.map(d => d.commission); // For tooltip if needed

            if (agentChartInstance) {
                agentChartInstance.destroy();
            }

            agentChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tickets Sold',
                        data: values,
                        backgroundColor: 'rgba(40, 167, 69, 0.6)',
                        borderColor: '#28a745',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const idx = context.dataIndex;
                                    return `Commission: $${comms[idx]}`;
                                }
                            }
                        }
                    }
                }
            });
        };

        // Initialize with Month view
        toggleAgentChart('month');
    });
</script>
{% endblock %}