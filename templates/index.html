{% extends "base.html" %}
{% block content %}

<style>
    /* Layout for Search Box (Left) and Results (Right) */
    .search-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }

    .search-panel {
        flex: 1;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .results-panel {
        flex: 2; /* Takes up twice as much space */
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        max-height: 600px;
        overflow-y: auto;
    }

    /* Styling for the "Small Boxes" (Suggestions) */
    .suggestion-box {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 5px;
        margin-bottom: 15px;
    }

    .chip {
        background-color: #e0e0e0;
        padding: 5px 10px;
        border-radius: 16px;
        font-size: 0.85em;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .chip:hover {
        background-color: #d0d0d0;
    }

    .chip.selected {
        background-color: #007bff;
        color: white;
    }

    /* Form Styling */
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .form-group input {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
    }

    /* Results Table Styling */
    .flight-card {
        border-bottom: 1px solid #eee;
        padding: 10px 0;
    }
    .flight-card:last-child {
        border-bottom: none;
    }
    .flight-header {
        font-weight: bold;
        color: #333;
    }
    .flight-route {
        color: #555;
    }
    .flight-price {
        color: #28a745;
        font-weight: bold;
        float: right;
    }
</style>

<h2>Welcome to Air Booking System</h2>

<div class="search-container">
    <!-- LEFT SIDE: Search Form -->
    <div class="search-panel">
        <h3>Find a Flight</h3>
        <form id="liveSearchForm" onsubmit="return false;"> <!-- Prevent default submit -->
            
            <div class="form-group">
                <label>Origin:</label>
                <input type="text" id="originInput" name="origin" placeholder="Airport or City" autocomplete="off">
                <!-- Small boxes for Origin -->
                <div id="originSuggestions" class="suggestion-box">
                    <!-- Chips injected by JS -->
                </div>
            </div>

            <div class="form-group">
                <label>Destination:</label>
                <input type="text" id="destInput" name="destination" placeholder="Airport or City" autocomplete="off">
                <!-- Small boxes for Destination -->
                <div id="destSuggestions" class="suggestion-box">
                    <!-- Chips injected by JS -->
                </div>
            </div>

            <div class="form-group">
                <label>Date:</label>
                <input type="date" id="dateInput" name="date">
            </div>
        </form>
    </div>

    <!-- RIGHT SIDE: Live Results -->
    <div class="results-panel">
        <h3>Available Flights</h3>
        <div id="resultsArea">
            <p style="color: #777;">Start typing or select a location to see flights...</p>
        </div>
    </div>
</div>

<hr>

<h3>Check In-Progress Flight Status</h3>
<form method="post" action="{{ url_for('public.status') }}">
    <label>Airline:</label>
    <input type="text" name="airline_name">
    <label>Flight No:</label>
    <input type="text" name="flight_number">
    <button type="submit">Check</button>
</form>

{% if status_flight %}
<p>Status: {{ status_flight.status }} | Departure: {{ status_flight.departure_time }} | Arrival: {{ status_flight.arrival_time }}</p>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const originInput = document.getElementById('originInput');
        const destInput = document.getElementById('destInput');
        const dateInput = document.getElementById('dateInput');
        const resultsArea = document.getElementById('resultsArea');

        // 1. Fetch available airports to populate the "Small Boxes"
        fetch("{{ url_for('public.get_airports') }}")
            .then(response => response.json())
            .then(airports => {
                populateSuggestions('originSuggestions', originInput, airports);
                populateSuggestions('destSuggestions', destInput, airports);
            });

        // Helper to create chips
        function populateSuggestions(containerId, inputElement, data) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            data.forEach(code => {
                const chip = document.createElement('span');
                chip.className = 'chip';
                chip.textContent = code;
                chip.onclick = () => {
                    // Set input value
                    inputElement.value = code;
                    // Trigger search immediately
                    performLiveSearch();
                };
                container.appendChild(chip);
            });
        }

        // 2. Event Listeners for Live Search
        // Trigger search whenever user types or changes date
        originInput.addEventListener('input', performLiveSearch);
        destInput.addEventListener('input', performLiveSearch);
        dateInput.addEventListener('change', performLiveSearch);

        // 3. The Search Logic
        function performLiveSearch() {
            const origin = originInput.value;
            const dest = destInput.value;
            const date = dateInput.value;

            // If everything is empty, clear results
            if (!origin && !dest && !date) {
                resultsArea.innerHTML = '<p style="color: #777;">Start typing or select a location to see flights...</p>';
                return;
            }

            // Build Query String
            const params = new URLSearchParams({
                origin: origin,
                destination: dest,
                date: date
            });

            fetch(`{{ url_for('public.live_search') }}?${params.toString()}`)
                .then(response => response.json())
                .then(flights => {
                    renderResults(flights);
                })
                .catch(err => console.error('Search failed', err));
        }

        // 4. Render Results Logic
        function renderResults(flights) {
            resultsArea.innerHTML = '';

            if (flights.length === 0) {
                resultsArea.innerHTML = '<p>No flights found matching your criteria.</p>';
                return;
            }

            const table = document.createElement('table');
            table.border = "1";
            table.style.width = "100%";
            table.style.borderCollapse = "collapse";
            
            // Header
            const thead = `
                <tr style="background: #eee;">
                    <th>Airline</th>
                    <th>Flight No</th>
                    <th>Route</th>
                    <th>Time</th>
                    <th>Price</th>
                    <th>Status</th>
                </tr>
            `;
            table.innerHTML = thead;

            flights.forEach(f => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${f.airline_name}</td>
                    <td>${f.flight_number}</td>
                    <td>${f.departure_airport} &rarr; ${f.arrival_airport}</td>
                    <td>
                        <small>Dep: ${f.departure_time}</small><br>
                        <small>Arr: ${f.arrival_time}</small>
                    </td>
                    <td style="font-weight:bold; color:green;">$${f.price}</td>
                    <td>${f.status}</td>
                `;
                table.appendChild(row);
            });

            resultsArea.appendChild(table);
        }
    });
</script>

{% endblock %}