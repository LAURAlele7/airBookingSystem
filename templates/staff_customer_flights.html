{% extends "base.html" %}
{% block title %}Customer Flight History{% endblock %}

{% block head_extra %}
<style>
    .dashboard-container { padding: 20px; }

    /* Flex container */
    .dashboard-content {
        display: flex;
        gap: 20px;
        align-items: flex-start;
    }

    /* Left Column: Filters */
    .filter-column {
        flex: 0 0 300px;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    /* Right Column: Results */
    .results-column {
        flex: 1;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #ddd;
        min-height: 500px;
    }

    /* Form Elements */
    .form-group { position: relative; margin-bottom: 15px; }
    .form-group label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }
    .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }

    /* Autocomplete Box */
    .suggestion-box {
        position: absolute;
        top: 100%; left: 0; right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.95em; }
    .suggestion-item:hover { background-color: #f0f0f0; }

    /* Table Styles */
    .flight-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .flight-table th, .flight-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    .flight-table th { background-color: #007bff; color: white; font-weight: bold; }

    .btn-action {
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 5px;
    }
    .btn-primary { background-color: #007bff; color: white; }
    .btn-secondary { background-color: #6c757d; color: white; margin-top: 10px; }
    .btn-primary:hover { background-color: #0056b3; }
    .btn-secondary:hover { background-color: #5a6268; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>Customer Flight History ({{ airline_name }})</h2>
        <a href="{{ url_for('staff.dashboard') }}" style="text-decoration: none; color: #007bff; font-weight: bold;">&larr; Back to Dashboard</a>
    </div>

    <div class="dashboard-content">
        <!-- LEFT COLUMN: Search -->
        <div class="filter-column">
            <h3>Search Customer</h3>
            <form id="searchForm" onsubmit="return false;">
                <div class="form-group">
                    <label>Customer Email</label>
                    <input type="email" id="customerEmailInput" placeholder="Start typing to search..." autocomplete="off">
                    <div id="customerSuggestions" class="suggestion-box"></div>
                </div>
                <button type="button" onclick="loadFlights()" class="btn-action btn-primary">Search</button>
                <button type="button" onclick="resetSearch()" class="btn-action btn-secondary">Reset</button>
            </form>
        </div>

        <!-- RIGHT COLUMN: Results -->
        <div class="results-column">
            <h3>Flight History</h3>
            <div id="resultsArea">
                <p style="color: #666;">Loading history...</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('customerEmailInput');
    const suggestionsBox = document.getElementById('customerSuggestions');
    const resultsArea = document.getElementById('resultsArea');
    let allCustomers = [];

    // 1. Fetch all customers for this airline for autocomplete
    fetch("{{ url_for('staff.get_customers') }}")
        .then(response => response.json())
        .then(data => {
            allCustomers = data;
        })
        .catch(err => console.error('Error loading customers:', err));

    // 2. Autocomplete Logic
    input.addEventListener('focus', () => filterAndShow(input.value));
    input.addEventListener('input', () => filterAndShow(input.value));

    document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !suggestionsBox.contains(e.target)) {
            suggestionsBox.style.display = 'none';
        }
    });

    function filterAndShow(val) {
        const lowerVal = val.toLowerCase();
        const filtered = allCustomers.filter(email => email.toLowerCase().includes(lowerVal));
        renderList(filtered);
        suggestionsBox.style.display = 'block';
    }

    function renderList(list) {
        suggestionsBox.innerHTML = '';
        if (list.length === 0) {
            suggestionsBox.innerHTML = '<div class="suggestion-item" style="color: #999; cursor: default;">No matching customers found</div>';
            return;
        }
        
        list.forEach(email => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = email;
            div.onclick = function() {
                input.value = email;
                suggestionsBox.style.display = 'none';
                loadFlights(); // Trigger search on selection
            };
            suggestionsBox.appendChild(div);
        });
    }

    // 3. Dynamic Search Function
    window.loadFlights = function() {
        const email = input.value.trim();
        // Removed empty check to allow loading all

        resultsArea.innerHTML = '<p style="color: #666;">Loading history...</p>';

        fetch(`{{ url_for('staff.api_customer_flights') }}?customer_email=${encodeURIComponent(email)}`)
            .then(res => res.json())
            .then(flights => {
                renderTable(flights);
            })
            .catch(err => {
                console.error(err);
                resultsArea.innerHTML = '<p style="color: red;">Error loading flight history.</p>';
            });
    };

    window.resetSearch = function() {
        input.value = '';
        loadFlights(); // Load all
    };

    function renderTable(flights) {
        if (flights.length === 0) {
            resultsArea.innerHTML = '<p style="padding: 15px; background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; border-radius: 4px;">No flights found.</p>';
            return;
        }

        let html = `
            <table class="flight-table">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Flight No</th>
                        <th>Route</th>
                        <th>Departure</th>
                        <th>Arrival</th>
                        <th>Status</th>
                        <th>Ticket ID</th>
                    </tr>
                </thead>
                <tbody>
        `;

        flights.forEach(f => {
            const depDisplay = f.dep_city ? `${f.dep_city} (${f.departure_airport})` : f.departure_airport;
            const arrDisplay = f.arr_city ? `${f.arr_city} (${f.arrival_airport})` : f.arrival_airport;
            const statusClass = 'status-' + f.status.toLowerCase().replace(' ', '-');

            html += `
                <tr>
                    <td>${f.customer_email}</td>
                    <td>${f.flight_number}</td>
                    <td>${depDisplay} &rarr; ${arrDisplay}</td>
                    <td>${f.departure_time}</td>
                    <td>${f.arrival_time}</td>
                    <td><span class="status-badge ${statusClass}">${f.status}</span></td>
                    <td>${f.ticket_ID}</td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        resultsArea.innerHTML = html;
    }

    // Initial load
    loadFlights();
});
</script>
{% endblock %}